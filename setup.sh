#! /bin/bash
set -e

# Change this please (!)
UBUNTU_PASSWORD=x2goletmein2020

# This can be obtained via tar + bzip + base64 combo
XFCE_CONFIG_DIR_TARBZ="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"

echo "Adding x2go repository..."
sudo add-apt-repository ppa:x2go/stable
sudo apt-get update
echo "Upgrading existing packages..."
DEBIAN_FRONTEND=noninteractive apt -yq dist-upgrade
echo "Installing x2go packages..."
sudo apt-get -y install x2goserver x2goserver-xsession xfce4 firefox



if [ ! -d "/home/ubuntu" ]; then
  echo "Home directory /home/ubuntu not present (possibly DigitalOcean) - creating it for consistency with AWS..."
  adduser --disabled-password --gecos "" ubuntu
  echo "Copying keys from root user..."
  cp -r /root/.ssh /home/ubuntu/.ssh
  chown -R ubuntu:ubuntu /home/ubuntu/.ssh
fi

echo "Putting customized Xfce configuration in the right place - this skips initial config dialog"
cd /home/ubuntu
rm -rf .config
echo $XFCE_CONFIG_DIR_TARBZ | base64 -d | tar xjf -


echo "Enabling password auth and setting specific password manually (keys not strictly required)..."
echo "ubuntu:${UBUNTU_PASSWORD}" | chpasswd
sed -i 's/PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
systemctl restart sshd

echo "Making ubuntu user root-like..."
echo >> /etc/sudoers
echo "ubuntu ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
echo >> /etc/sudoers

echo "Provisioning finished."
